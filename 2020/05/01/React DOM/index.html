<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"github.com","root":"/","images":"/images","scheme":"Mist","version":"8.3.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}};
  </script>
<meta name="description" content="React 学习">
<meta property="og:type" content="article">
<meta property="og:title" content="React DOM">
<meta property="og:url" content="https://github.com/iosh/H.git/2020/05/01/React%20DOM/index.html">
<meta property="og:site_name" content="胡先生">
<meta property="og:description" content="React 学习">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-05-01T22:58:55.000Z">
<meta property="article:modified_time" content="2021-04-14T08:31:47.422Z">
<meta property="article:author" content="H">
<meta property="article:tag" content="React">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://github.com/iosh/H.git/2020/05/01/React%20DOM/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>
<title>React DOM | 胡先生</title>
  




  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">胡先生</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#ReactDOM"><span class="nav-number">1.</span> <span class="nav-text">ReactDOM</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ReactDOM-render"><span class="nav-number">1.1.</span> <span class="nav-text">ReactDOM.render</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#legacyRenderSubtreeIntoContainer"><span class="nav-number">1.2.</span> <span class="nav-text">legacyRenderSubtreeIntoContainer</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Initial-mount"><span class="nav-number">1.3.</span> <span class="nav-text">Initial mount</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#legacyCreateRootFromDOMContainer"><span class="nav-number">1.3.1.</span> <span class="nav-text">legacyCreateRootFromDOMContainer</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#createLegacyRoot"><span class="nav-number">1.3.2.</span> <span class="nav-text">createLegacyRoot</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#react-reconciler"><span class="nav-number">1.4.</span> <span class="nav-text">react-reconciler</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#createContainer"><span class="nav-number">1.4.1.</span> <span class="nav-text">createContainer</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#createFiberRoot"><span class="nav-number">1.4.2.</span> <span class="nav-text">createFiberRoot</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#FiberRoot"><span class="nav-number">1.4.3.</span> <span class="nav-text">FiberRoot</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Fiber-Node"><span class="nav-number">1.4.4.</span> <span class="nav-text">Fiber Node</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Initial-Update"><span class="nav-number">1.5.</span> <span class="nav-text">Initial Update</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#unbatchedUpdates"><span class="nav-number">1.5.1.</span> <span class="nav-text">unbatchedUpdates</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#updateContainer"><span class="nav-number">1.5.2.</span> <span class="nav-text">updateContainer</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#performSyncWorkOnRoot"><span class="nav-number">1.5.3.</span> <span class="nav-text">performSyncWorkOnRoot</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#renderRootSync"><span class="nav-number">1.5.4.</span> <span class="nav-text">renderRootSync</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#workLoopSync"><span class="nav-number">1.5.5.</span> <span class="nav-text">workLoopSync</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#performUnitOfWork-%E5%87%BD%E6%95%B0"><span class="nav-number">1.5.6.</span> <span class="nav-text">performUnitOfWork 函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#beginWork"><span class="nav-number">1.5.7.</span> <span class="nav-text">beginWork</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#originalBeginWork"><span class="nav-number">1.5.8.</span> <span class="nav-text">originalBeginWork</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#commit"><span class="nav-number">1.6.</span> <span class="nav-text">commit</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#finishSyncRender"><span class="nav-number">1.6.1.</span> <span class="nav-text">finishSyncRender</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#commitRootImpl"><span class="nav-number">1.6.2.</span> <span class="nav-text">commitRootImpl</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">H</p>
  <div class="site-description" itemprop="description">个人学习笔记</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">60</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">29</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/iosh" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;iosh"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://github.com/iosh/H.git/2020/05/01/React%20DOM/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="H">
      <meta itemprop="description" content="个人学习笔记">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="胡先生">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          React DOM
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-05-01 22:58:55" itemprop="dateCreated datePublished" datetime="2020-05-01T22:58:55+00:00">2020-05-01</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-04-14 08:31:47" itemprop="dateModified" datetime="2021-04-14T08:31:47+00:00">2021-04-14</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>React 学习</p>
<span id="more"></span>

<p>主要是了解 React DOM 初次渲染的过程,不涉及更新部分.</p>
<h1 id="ReactDOM"><a href="#ReactDOM" class="headerlink" title="ReactDOM"></a>ReactDOM</h1><p>ReactDOM 是 React 的 DOM 和 server 的 <code>renderers</code></p>
<h2 id="ReactDOM-render"><a href="#ReactDOM-render" class="headerlink" title="ReactDOM.render"></a>ReactDOM.render</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  element: React$Element&lt;<span class="built_in">any</span>&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  container: Container,</span></span></span><br><span class="line"><span class="function"><span class="params">  callback: ?<span class="built_in">Function</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 检查 container 是否为 DOM 元素</span></span><br><span class="line">  invariant(</span><br><span class="line">    isValidContainer(container),</span><br><span class="line">    <span class="string">&quot;Target container is not a DOM element.&quot;</span></span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">return</span> legacyRenderSubtreeIntoContainer(</span><br><span class="line">    <span class="literal">null</span>,</span><br><span class="line">    element,</span><br><span class="line">    container,</span><br><span class="line">    <span class="literal">false</span>,</span><br><span class="line">    callback</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="legacyRenderSubtreeIntoContainer"><a href="#legacyRenderSubtreeIntoContainer" class="headerlink" title="legacyRenderSubtreeIntoContainer"></a>legacyRenderSubtreeIntoContainer</h2><p>通过函数可以看到 React 会在 Container DOM 上添加一个 _reactRootContainer 属性, 值由 legacyCreateRootFromDOMContainer 函数的返回值</p>
<p>所以函数内会判断这个值是否存在如果存在的话就会使用他的值,如果不存在就调用函数创建它</p>
<p>从代码注释中可以得到, React 分为 mount 和 update 两个阶段</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">legacyRenderSubtreeIntoContainer</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  parentComponent: ?React$Component&lt;<span class="built_in">any</span>, <span class="built_in">any</span>&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  children: ReactNodeList,</span></span></span><br><span class="line"><span class="function"><span class="params">  container: Container,</span></span></span><br><span class="line"><span class="function"><span class="params">  forceHydrate: <span class="built_in">boolean</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  callback: ?<span class="built_in">Function</span>,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> Without `any` type, Flow says &quot;Property cannot be accessed on any</span></span><br><span class="line">  <span class="comment">// member of intersection type.&quot; Whyyyyyy.</span></span><br><span class="line">  <span class="keyword">let</span> root: RootType = (container._reactRootContainer: <span class="built_in">any</span>);</span><br><span class="line">  <span class="keyword">let</span> fiberRoot;</span><br><span class="line">  <span class="keyword">if</span> (!root) &#123;</span><br><span class="line">    <span class="comment">// Initial mount</span></span><br><span class="line">    root = container._reactRootContainer = legacyCreateRootFromDOMContainer(</span><br><span class="line">      container,</span><br><span class="line">      forceHydrate,</span><br><span class="line">    );</span><br><span class="line">    fiberRoot = root._internalRoot;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> callback === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> originalCallback = callback;</span><br><span class="line">      callback = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> instance = getPublicRootInstance(fiberRoot);</span><br><span class="line">        originalCallback.call(instance);</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Initial mount should not be batched.</span></span><br><span class="line">    unbatchedUpdates(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      updateContainer(children, fiberRoot, parentComponent, callback);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    fiberRoot = root._internalRoot;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> callback === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> originalCallback = callback;</span><br><span class="line">      callback = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> instance = getPublicRootInstance(fiberRoot);</span><br><span class="line">        originalCallback.call(instance);</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Update</span></span><br><span class="line">    updateContainer(children, fiberRoot, parentComponent, callback);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> getPublicRootInstance(fiberRoot);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Initial-mount"><a href="#Initial-mount" class="headerlink" title="Initial mount"></a>Initial mount</h2><h3 id="legacyCreateRootFromDOMContainer"><a href="#legacyCreateRootFromDOMContainer" class="headerlink" title="legacyCreateRootFromDOMContainer"></a>legacyCreateRootFromDOMContainer</h3><p>函数本身功能比较单一, 出去检查是否为服务端渲染, 如果不是服务端渲染那么清除容器内部的所有元素.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">legacyCreateRootFromDOMContainer</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  container: Container,</span></span></span><br><span class="line"><span class="function"><span class="params">  forceHydrate: <span class="built_in">boolean</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">RootType</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> shouldHydrate =</span><br><span class="line">    forceHydrate || shouldHydrateDueToLegacyHeuristic(container);</span><br><span class="line">  <span class="comment">// First clear any existing content.</span></span><br><span class="line">  <span class="keyword">if</span> (!shouldHydrate) &#123;</span><br><span class="line">    <span class="keyword">let</span> warned = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">let</span> rootSibling;</span><br><span class="line">    <span class="keyword">while</span> ((rootSibling = container.lastChild)) &#123;</span><br><span class="line">      <span class="comment">// 省略检查代码</span></span><br><span class="line">      container.removeChild(rootSibling);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 省略检查代码</span></span><br><span class="line">  <span class="keyword">return</span> createLegacyRoot(</span><br><span class="line">    container,</span><br><span class="line">    shouldHydrate</span><br><span class="line">      ? &#123;</span><br><span class="line">          hydrate: <span class="literal">true</span>,</span><br><span class="line">        &#125;</span><br><span class="line">      : <span class="literal">undefined</span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="createLegacyRoot"><a href="#createLegacyRoot" class="headerlink" title="createLegacyRoot"></a>createLegacyRoot</h3><p>直接生成 ReactDOMBlockingRoot 实例然后返回</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createLegacyRoot</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  container: Container,</span></span></span><br><span class="line"><span class="function"><span class="params">  options?: RootOptions</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">RootType</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> ReactDOMBlockingRoot(container, LegacyRoot, options);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ReactDOMBlockingRoot</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  container: Container,</span></span></span><br><span class="line"><span class="function"><span class="params">  tag: RootTag,</span></span></span><br><span class="line"><span class="function"><span class="params">  options: <span class="built_in">void</span> | RootOptions</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">this</span>._internalRoot = createRootImpl(container, tag, options);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createRootImpl</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  container: Container,</span></span></span><br><span class="line"><span class="function"><span class="params">  tag: RootTag,</span></span></span><br><span class="line"><span class="function"><span class="params">  options: <span class="built_in">void</span> | RootOptions</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Tag is either LegacyRoot or Concurrent Root</span></span><br><span class="line">  <span class="keyword">const</span> hydrate = options != <span class="literal">null</span> &amp;&amp; options.hydrate === <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">const</span> hydrationCallbacks =</span><br><span class="line">    (options != <span class="literal">null</span> &amp;&amp; options.hydrationOptions) || <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">const</span> root = createContainer(container, tag, hydrate, hydrationCallbacks);</span><br><span class="line">  markContainerAsRoot(root.current, container); <span class="comment">// 向 DOM 添加数据</span></span><br><span class="line">  <span class="keyword">if</span> (hydrate &amp;&amp; tag !== LegacyRoot) &#123;</span><br><span class="line">    <span class="keyword">const</span> doc =</span><br><span class="line">      container.nodeType === DOCUMENT_NODE</span><br><span class="line">        ? container</span><br><span class="line">        : container.ownerDocument;</span><br><span class="line">    eagerlyTrapReplayableEvents(container, doc);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> root;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>createContainer 是 react-reconciler 包里面的方法</p>
<h2 id="react-reconciler"><a href="#react-reconciler" class="headerlink" title="react-reconciler"></a>react-reconciler</h2><p><a href="https://github.com/facebook/react/blob/master/packages/react-reconciler/README.md">document</a></p>
<h3 id="createContainer"><a href="#createContainer" class="headerlink" title="createContainer"></a>createContainer</h3><p>createContainer 函数 return 了 createFiberRoot 函数</p>
<h3 id="createFiberRoot"><a href="#createFiberRoot" class="headerlink" title="createFiberRoot"></a>createFiberRoot</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createFiberRoot</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  containerInfo: <span class="built_in">any</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  tag: RootTag,</span></span></span><br><span class="line"><span class="function"><span class="params">  hydrate: <span class="built_in">boolean</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  hydrationCallbacks: <span class="literal">null</span> | SuspenseHydrationCallbacks,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">FiberRoot</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 会创建一个 FiberRoot</span></span><br><span class="line">  <span class="keyword">const</span> root: FiberRoot = (<span class="keyword">new</span> FiberRootNode(containerInfo, tag, hydrate): <span class="built_in">any</span>);</span><br><span class="line">  <span class="keyword">if</span> (enableSuspenseCallback) &#123; <span class="comment">// 开启新特性, 默认为false</span></span><br><span class="line">    root.hydrationCallbacks = hydrationCallbacks;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Cyclic construction. This cheats the type system right now because</span></span><br><span class="line">  <span class="comment">// stateNode is any.</span></span><br><span class="line">  <span class="keyword">const</span> uninitializedFiber = createHostRootFiber(tag); <span class="comment">// tag 的值分别是 0 1 2 , 其中 0 是 16.13 默认模式 1 2 都是未来的试验模式</span></span><br><span class="line">  root.current = uninitializedFiber;</span><br><span class="line">  uninitializedFiber.stateNode = root;</span><br><span class="line"></span><br><span class="line">  initializeUpdateQueue(uninitializedFiber);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> root;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里出现了一个 FiberRootNode 这是 Fiber 里面的一个数据结构</p>
<h3 id="FiberRoot"><a href="#FiberRoot" class="headerlink" title="FiberRoot"></a>FiberRoot</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> BaseFiberRootProperties = &#123;|</span><br><span class="line">  <span class="comment">// The type of root (legacy, batched, concurrent, etc.)</span></span><br><span class="line">  tag: RootTag, <span class="comment">// 16.13 当前 RootTag React.render 使用的值为0 对应 legacy</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Any additional information from the host associated with this root.</span></span><br><span class="line">  <span class="comment">// root 节点 DOM 容器</span></span><br><span class="line">  containerInfo: <span class="built_in">any</span>,</span><br><span class="line">  <span class="comment">// Used only by persistent updates.</span></span><br><span class="line">  <span class="comment">// 仅用于数据持久化 在 ReactDOM 中不会用到</span></span><br><span class="line">  pendingChildren: <span class="built_in">any</span>,</span><br><span class="line">  <span class="comment">// The currently active root fiber. This is the mutable root of the tree.</span></span><br><span class="line">  <span class="comment">// 当前活动的 root fiber, 是当前树的可变根</span></span><br><span class="line">  current: Fiber,</span><br><span class="line"></span><br><span class="line">  pingCache: <span class="built_in">WeakMap</span>&lt;Wakeable, <span class="built_in">Set</span>&lt;mixed&gt;&gt; | <span class="built_in">Map</span>&lt;Wakeable, <span class="built_in">Set</span>&lt;mixed&gt;&gt; | <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// A finished work-in-progress HostRoot that&#x27;s ready to be committed.</span></span><br><span class="line">  <span class="comment">// 已经处理完成的 HostRoot 可以准备 commited</span></span><br><span class="line">  finishedWork: Fiber | <span class="literal">null</span>,</span><br><span class="line">  <span class="comment">// Timeout handle returned by setTimeout. Used to cancel a pending timeout, if</span></span><br><span class="line">  <span class="comment">// it&#x27;s superseded by a new one.</span></span><br><span class="line">  <span class="comment">//  setTimeout 返回的值</span></span><br><span class="line">  timeoutHandle: TimeoutHandle | NoTimeout,</span><br><span class="line">  <span class="comment">// Top context object, used by renderSubtreeIntoContainer</span></span><br><span class="line">  <span class="comment">// 顶级 context 对象, 用于 renderSubtreeIntoContainer 函数</span></span><br><span class="line">  context: <span class="built_in">Object</span> | <span class="literal">null</span>,</span><br><span class="line">  <span class="comment">// 新的Context 如果有 用于替换 context</span></span><br><span class="line">  pendingContext: <span class="built_in">Object</span> | <span class="literal">null</span>,</span><br><span class="line">  <span class="comment">// Determines if we should attempt to hydrate on the initial mount</span></span><br><span class="line">  <span class="comment">// 服务端渲染使用</span></span><br><span class="line">  +hydrate: <span class="built_in">boolean</span>,</span><br><span class="line">  <span class="comment">// Node returned by Scheduler.scheduleCallback</span></span><br><span class="line">  <span class="comment">// Scheduler.scheduleCallback 函数的返回值</span></span><br><span class="line">  callbackNode: *,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Only used by old reconciler</span></span><br><span class="line">  <span class="comment">// 仅用于旧的 reconciler</span></span><br><span class="line">  <span class="comment">// Expiration of the callback associated with this root</span></span><br><span class="line">  <span class="comment">// 与此 root 相关的回调截止时间</span></span><br><span class="line">  callbackExpirationTime: ExpirationTime,</span><br><span class="line">  <span class="comment">// Priority of the callback associated with this root</span></span><br><span class="line">  <span class="comment">// 与此root相关的回调优先级</span></span><br><span class="line">  callbackPriority: ReactPriorityLevel,<span class="comment">// 普通为90 最高 99</span></span><br><span class="line">  <span class="comment">// 完成的截止时间</span></span><br><span class="line">  finishedExpirationTime: ExpirationTime,</span><br><span class="line">  <span class="comment">// The earliest pending expiration time that exists in the tree</span></span><br><span class="line">  <span class="comment">// 当前树存在的最早过期时间</span></span><br><span class="line">  firstPendingTime: ExpirationTime,</span><br><span class="line">  <span class="comment">// The latest pending expiration time that exists in the tree</span></span><br><span class="line">  <span class="comment">// 最晚过期时间</span></span><br><span class="line">  lastPendingTime: ExpirationTime,</span><br><span class="line">  <span class="comment">// The earliest suspended expiration time that exists in the tree</span></span><br><span class="line">  <span class="comment">// 当前树存在的最早暂停时间</span></span><br><span class="line">  firstSuspendedTime: ExpirationTime,</span><br><span class="line">  <span class="comment">// The latest suspended expiration time that exists in the tree</span></span><br><span class="line">  <span class="comment">// 最晚暂停时间</span></span><br><span class="line">  lastSuspendedTime: ExpirationTime,</span><br><span class="line">  <span class="comment">// The next known expiration time after the suspended range</span></span><br><span class="line">  <span class="comment">// 下一个已知的 暂停时间范围的截止时间</span></span><br><span class="line">  nextKnownPendingLevel: ExpirationTime,</span><br><span class="line">  <span class="comment">// The latest time at which a suspended component pinged the root to</span></span><br><span class="line">  <span class="comment">// render again</span></span><br><span class="line">  lastPingedTime: ExpirationTime,</span><br><span class="line">  lastExpiredTime: ExpirationTime,</span><br><span class="line">  <span class="comment">// Used by useMutableSource hook to avoid tearing within this root</span></span><br><span class="line">  <span class="comment">// when external, mutable sources are read from during render.</span></span><br><span class="line">  mutableSourceLastPendingUpdateTime: ExpirationTime,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Only used by new reconciler</span></span><br><span class="line">  <span class="comment">// 仅用于 新的  reconciler</span></span><br><span class="line">  <span class="comment">// Represents the next task that the root should work on, or the current one</span></span><br><span class="line">  <span class="comment">// if it&#x27;s already working.</span></span><br><span class="line">  callbackId: Lanes,</span><br><span class="line">  <span class="comment">// Whether the currently scheduled task for this root is synchronous or</span></span><br><span class="line">  <span class="comment">// batched/concurrent. We have to track this because Scheduler does not</span></span><br><span class="line">  <span class="comment">// support synchronous tasks, so we put those on a separate queue. So you</span></span><br><span class="line">  <span class="comment">// could also think of this as &quot;which queue is the callback scheduled with?&quot;</span></span><br><span class="line">  callbackIsSync: <span class="built_in">boolean</span>,</span><br><span class="line">  <span class="comment">// Timestamp at which we will synchronously finish the current task to</span></span><br><span class="line">  <span class="comment">// prevent starvation.</span></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> There should be a separate expiration per lane.</span></span><br><span class="line">  <span class="comment">// <span class="doctag">NOTE:</span> This is not an &quot;ExpirationTime&quot; as used by the old reconciler. It&#x27;s a</span></span><br><span class="line">  <span class="comment">// timestamp, in milliseconds.</span></span><br><span class="line">  expiresAt: <span class="built_in">number</span>,</span><br><span class="line"></span><br><span class="line">  pendingLanes: Lanes,</span><br><span class="line">  suspendedLanes: Lanes,</span><br><span class="line">  pingedLanes: Lanes,</span><br><span class="line">  expiredLanes: Lanes,</span><br><span class="line">  mutableReadLanes: Lanes,</span><br><span class="line"></span><br><span class="line">  finishedLanes: Lanes,</span><br><span class="line">|&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Fiber-Node"><a href="#Fiber-Node" class="headerlink" title="Fiber Node"></a>Fiber Node</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> Fiber = &#123;|</span><br><span class="line">  <span class="comment">// These first fields are conceptually members of an Instance. This used to</span></span><br><span class="line">  <span class="comment">// be split into a separate type and intersected with the other Fiber fields,</span></span><br><span class="line">  <span class="comment">// but until Flow fixes its intersection bugs, we&#x27;ve merged them into a</span></span><br><span class="line">  <span class="comment">// single type.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// An Instance is shared between all versions of a component. We can easily</span></span><br><span class="line">  <span class="comment">// break this out into a separate object to avoid copying so much to the</span></span><br><span class="line">  <span class="comment">// alternate versions of the tree. We put this on a single object for now to</span></span><br><span class="line">  <span class="comment">// minimize the number of objects created during the initial render.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Tag identifying the type of fiber.</span></span><br><span class="line">  <span class="comment">// 识别 fiber 的类型 0 - 24</span></span><br><span class="line">  <span class="comment">// packages/react-reconciler/src/ReactWorkTags.js</span></span><br><span class="line">  tag: WorkTag, <span class="comment">// 函数组件是 0 class组件是 1 还没确定是函数还是类的时候是 2 HostRoot 是 3 其他参考文件</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Unique identifier of this child.</span></span><br><span class="line">  <span class="comment">// key 唯一标示</span></span><br><span class="line">  key: <span class="literal">null</span> | <span class="built_in">string</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The value of element.type which is used to preserve the identity during</span></span><br><span class="line">  <span class="comment">// reconciliation of this child.</span></span><br><span class="line">  <span class="comment">// react element 对象的 type 值.</span></span><br><span class="line">  elementType: <span class="built_in">any</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The resolved function/class/ associated with this fiber.</span></span><br><span class="line">  <span class="keyword">type</span>: <span class="built_in">any</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The local state associated with this fiber.</span></span><br><span class="line">  <span class="comment">// 与 fiber 相关的本地实现</span></span><br><span class="line">  stateNode: <span class="built_in">any</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Conceptual aliases</span></span><br><span class="line">  <span class="comment">// 概念别名</span></span><br><span class="line">  <span class="comment">// parent : Instance -&gt; return The parent happens to be the same as the</span></span><br><span class="line">  <span class="comment">// return fiber since we&#x27;ve merged the fiber and instance.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Remaining fields belong to Fiber</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// The Fiber to return to after finishing processing this one.</span></span><br><span class="line">  <span class="comment">// This is effectively the parent, but there can be multiple parents (two)</span></span><br><span class="line">  <span class="comment">// so this is only the parent of the thing we&#x27;re currently processing.</span></span><br><span class="line">  <span class="comment">// It is conceptually the same as the return address of a stack frame.</span></span><br><span class="line">  <span class="comment">// 父级的引用, 类似链表的 previous ,实际上就是父节点,但是可能有多个父节点, Fiber 加工完成之后通过此值返回</span></span><br><span class="line">  <span class="keyword">return</span>: Fiber | <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Singly Linked List Tree Structure.</span></span><br><span class="line">  <span class="comment">// 单向链表的下一个Fiber对象</span></span><br><span class="line">  child: Fiber | <span class="literal">null</span>,</span><br><span class="line">  <span class="comment">// 兄弟节点</span></span><br><span class="line">  sibling: Fiber | <span class="literal">null</span>,</span><br><span class="line">  index: <span class="built_in">number</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The ref last used to attach this node.</span></span><br><span class="line">  <span class="comment">// I&#x27;ll avoid adding an owner field for prod and model that as functions.</span></span><br><span class="line">  <span class="comment">// ref</span></span><br><span class="line">  ref:</span><br><span class="line">    | <span class="literal">null</span></span><br><span class="line">    | ((<span class="function">(<span class="params">handle: mixed</span>) =&gt;</span> <span class="built_in">void</span>) &amp; &#123;<span class="attr">_stringRef</span>: ?<span class="built_in">string</span>, ...&#125;)</span><br><span class="line">    | RefObject,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Input is the data coming into process this fiber. Arguments. Props.</span></span><br><span class="line">  pendingProps: <span class="built_in">any</span>, <span class="comment">// This type will be more specific once we overload the tag.</span></span><br><span class="line">  memoizedProps: <span class="built_in">any</span>, <span class="comment">// The props used to create the output.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// A queue of state updates and callbacks.</span></span><br><span class="line">  updateQueue: mixed,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The state used to create the output</span></span><br><span class="line">  memoizedState: <span class="built_in">any</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Dependencies (contexts, events) for this fiber, if it has any</span></span><br><span class="line">  dependencies_new: Dependencies_new | <span class="literal">null</span>,</span><br><span class="line">  dependencies_old: Dependencies_old | <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Bitfield that describes properties about the fiber and its subtree. E.g.</span></span><br><span class="line">  <span class="comment">// the ConcurrentMode flag indicates whether the subtree should be async-by-</span></span><br><span class="line">  <span class="comment">// default. When a fiber is created, it inherits the mode of its</span></span><br><span class="line">  <span class="comment">// parent. Additional flags can be set at creation time, but after that the</span></span><br><span class="line">  <span class="comment">// value should remain unchanged throughout the fiber&#x27;s lifetime, particularly</span></span><br><span class="line">  <span class="comment">// before its child fibers are created.</span></span><br><span class="line">  mode: TypeOfMode, <span class="comment">// packages/react-reconciler/src/ReactTypeOfMode.js 几种模式</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Effect</span></span><br><span class="line">  effectTag: SideEffectTag,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Singly linked list fast path to the next fiber with side-effects.</span></span><br><span class="line">  nextEffect: Fiber | <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The first and last fiber with side-effect within this subtree. This allows</span></span><br><span class="line">  <span class="comment">// us to reuse a slice of the linked list when we reuse the work done within</span></span><br><span class="line">  <span class="comment">// this fiber.</span></span><br><span class="line">  firstEffect: Fiber | <span class="literal">null</span>,</span><br><span class="line">  lastEffect: Fiber | <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Only used by old reconciler</span></span><br><span class="line">  expirationTime: ExpirationTime,</span><br><span class="line">  childExpirationTime: ExpirationTime,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Only used by new reconciler</span></span><br><span class="line">  lanes: Lanes,</span><br><span class="line">  childLanes: Lanes,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// This is a pooled version of a Fiber. Every fiber that gets updated will</span></span><br><span class="line">  <span class="comment">// eventually have a pair. There are cases when we can clean up pairs to save</span></span><br><span class="line">  <span class="comment">// memory if we need to.</span></span><br><span class="line">  alternate: Fiber | <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Time spent rendering this Fiber and its descendants for the current update.</span></span><br><span class="line">  <span class="comment">// This tells us how well the tree makes use of sCU for memoization.</span></span><br><span class="line">  <span class="comment">// It is reset to 0 each time we render and only updated when we don&#x27;t bailout.</span></span><br><span class="line">  <span class="comment">// This field is only set when the enableProfilerTimer flag is enabled.</span></span><br><span class="line">  <span class="comment">// 渲染这棵树和他的后代所花费的时间.</span></span><br><span class="line">  actualDuration?: <span class="built_in">number</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If the Fiber is currently active in the &quot;render&quot; phase,</span></span><br><span class="line">  <span class="comment">// This marks the time at which the work began.</span></span><br><span class="line">  <span class="comment">// This field is only set when the enableProfilerTimer flag is enabled.</span></span><br><span class="line">  actualStartTime?: <span class="built_in">number</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Duration of the most recent render time for this Fiber.</span></span><br><span class="line">  <span class="comment">// This value is not updated when we bailout for memoization purposes.</span></span><br><span class="line">  <span class="comment">// This field is only set when the enableProfilerTimer flag is enabled.</span></span><br><span class="line">  selfBaseDuration?: <span class="built_in">number</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Sum of base times for all descendants of this Fiber.</span></span><br><span class="line">  <span class="comment">// This value bubbles up during the &quot;complete&quot; phase.</span></span><br><span class="line">  <span class="comment">// This field is only set when the enableProfilerTimer flag is enabled.</span></span><br><span class="line">  treeBaseDuration?: <span class="built_in">number</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Conceptual aliases</span></span><br><span class="line">  <span class="comment">// workInProgress : Fiber -&gt;  alternate The alternate used for reuse happens</span></span><br><span class="line">  <span class="comment">// to be the same as work in progress.</span></span><br><span class="line">  <span class="comment">// __DEV__ only</span></span><br><span class="line">  _debugID?: <span class="built_in">number</span>,</span><br><span class="line">  _debugSource?: Source | <span class="literal">null</span>,</span><br><span class="line">  _debugOwner?: Fiber | <span class="literal">null</span>,</span><br><span class="line">  _debugIsCurrentlyTiming?: <span class="built_in">boolean</span>,</span><br><span class="line">  _debugNeedsRemount?: <span class="built_in">boolean</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Used to verify that the order of hooks does not change between renders.</span></span><br><span class="line">  _debugHookTypes?: <span class="built_in">Array</span>&lt;HookType&gt; | <span class="literal">null</span>,</span><br><span class="line">|&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> BaseFiberRootProperties = &#123;|</span><br><span class="line">  <span class="comment">// The type of root (legacy, batched, concurrent, etc.)</span></span><br><span class="line">  tag: RootTag,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Any additional information from the host associated with this root.</span></span><br><span class="line">  containerInfo: <span class="built_in">any</span>,</span><br><span class="line">  <span class="comment">// Used only by persistent updates.</span></span><br><span class="line">  pendingChildren: <span class="built_in">any</span>,</span><br><span class="line">  <span class="comment">// The currently active root fiber. This is the mutable root of the tree.</span></span><br><span class="line">  current: Fiber,</span><br><span class="line"></span><br><span class="line">  pingCache: <span class="built_in">WeakMap</span>&lt;Wakeable, <span class="built_in">Set</span>&lt;mixed&gt;&gt; | <span class="built_in">Map</span>&lt;Wakeable, <span class="built_in">Set</span>&lt;mixed&gt;&gt; | <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// A finished work-in-progress HostRoot that&#x27;s ready to be committed.</span></span><br><span class="line">  finishedWork: Fiber | <span class="literal">null</span>,</span><br><span class="line">  <span class="comment">// Timeout handle returned by setTimeout. Used to cancel a pending timeout, if</span></span><br><span class="line">  <span class="comment">// it&#x27;s superseded by a new one.</span></span><br><span class="line">  timeoutHandle: TimeoutHandle | NoTimeout,</span><br><span class="line">  <span class="comment">// Top context object, used by renderSubtreeIntoContainer</span></span><br><span class="line">  context: <span class="built_in">Object</span> | <span class="literal">null</span>,</span><br><span class="line">  pendingContext: <span class="built_in">Object</span> | <span class="literal">null</span>,</span><br><span class="line">  <span class="comment">// Determines if we should attempt to hydrate on the initial mount</span></span><br><span class="line">  +hydrate: <span class="built_in">boolean</span>,</span><br><span class="line">  <span class="comment">// Node returned by Scheduler.scheduleCallback</span></span><br><span class="line">  callbackNode: *,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Only used by old reconciler</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Expiration of the callback associated with this root</span></span><br><span class="line">  callbackExpirationTime: ExpirationTime,</span><br><span class="line">  <span class="comment">// Priority of the callback associated with this root</span></span><br><span class="line">  callbackPriority: ReactPriorityLevel,</span><br><span class="line"></span><br><span class="line">  finishedExpirationTime: ExpirationTime,</span><br><span class="line">  <span class="comment">// The earliest pending expiration time that exists in the tree</span></span><br><span class="line">  firstPendingTime: ExpirationTime,</span><br><span class="line">  <span class="comment">// The latest pending expiration time that exists in the tree</span></span><br><span class="line">  lastPendingTime: ExpirationTime,</span><br><span class="line">  <span class="comment">// The earliest suspended expiration time that exists in the tree</span></span><br><span class="line">  firstSuspendedTime: ExpirationTime,</span><br><span class="line">  <span class="comment">// The latest suspended expiration time that exists in the tree</span></span><br><span class="line">  lastSuspendedTime: ExpirationTime,</span><br><span class="line">  <span class="comment">// The next known expiration time after the suspended range</span></span><br><span class="line">  nextKnownPendingLevel: ExpirationTime,</span><br><span class="line">  <span class="comment">// The latest time at which a suspended component pinged the root to</span></span><br><span class="line">  <span class="comment">// render again</span></span><br><span class="line">  lastPingedTime: ExpirationTime,</span><br><span class="line">  lastExpiredTime: ExpirationTime,</span><br><span class="line">  <span class="comment">// Used by useMutableSource hook to avoid tearing within this root</span></span><br><span class="line">  <span class="comment">// when external, mutable sources are read from during render.</span></span><br><span class="line">  mutableSourceLastPendingUpdateTime: ExpirationTime,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Only used by new reconciler</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Represents the next task that the root should work on, or the current one</span></span><br><span class="line">  <span class="comment">// if it&#x27;s already working.</span></span><br><span class="line">  callbackId: Lanes,</span><br><span class="line">  <span class="comment">// Whether the currently scheduled task for this root is synchronous or</span></span><br><span class="line">  <span class="comment">// batched/concurrent. We have to track this because Scheduler does not</span></span><br><span class="line">  <span class="comment">// support synchronous tasks, so we put those on a separate queue. So you</span></span><br><span class="line">  <span class="comment">// could also think of this as &quot;which queue is the callback scheduled with?&quot;</span></span><br><span class="line">  callbackIsSync: <span class="built_in">boolean</span>,</span><br><span class="line">  <span class="comment">// Timestamp at which we will synchronously finish the current task to</span></span><br><span class="line">  <span class="comment">// prevent starvation.</span></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> There should be a separate expiration per lane.</span></span><br><span class="line">  <span class="comment">// <span class="doctag">NOTE:</span> This is not an &quot;ExpirationTime&quot; as used by the old reconciler. It&#x27;s a</span></span><br><span class="line">  <span class="comment">// timestamp, in milliseconds.</span></span><br><span class="line">  expiresAt: <span class="built_in">number</span>,</span><br><span class="line"></span><br><span class="line">  pendingLanes: Lanes,</span><br><span class="line">  suspendedLanes: Lanes,</span><br><span class="line">  pingedLanes: Lanes,</span><br><span class="line">  expiredLanes: Lanes,</span><br><span class="line">  mutableReadLanes: Lanes,</span><br><span class="line"></span><br><span class="line">  finishedLanes: Lanes,</span><br><span class="line">|&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>自此 初始化阶段完毕, FiberRoot 和 RootFiber 都创建完毕接下来进入初次更新阶段</p>
<h2 id="Initial-Update"><a href="#Initial-Update" class="headerlink" title="Initial Update"></a>Initial Update</h2><h3 id="unbatchedUpdates"><a href="#unbatchedUpdates" class="headerlink" title="unbatchedUpdates"></a>unbatchedUpdates</h3><p>legacyRenderSubtreeIntoContainer 函数中的</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Initial mount should not be batched.</span></span><br><span class="line">unbatchedUpdates(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// childen 为 React.render 第一个参数 React element 对象</span></span><br><span class="line">  <span class="comment">// fiberRoot 是在上面创建了.仅仅是一个 FiberRoot 和它的 RootFiber</span></span><br><span class="line">  updateContainer(children, fiberRoot, parentComponent, callback);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>executionContext 表明了当前正处于什么上下文,目前有七个:</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> NoContext = <span class="comment">/*                    */</span> <span class="number">0b000000</span>;</span><br><span class="line"><span class="keyword">const</span> BatchedContext = <span class="comment">/*               */</span> <span class="number">0b000001</span>;</span><br><span class="line"><span class="keyword">const</span> EventContext = <span class="comment">/*                 */</span> <span class="number">0b000010</span>;</span><br><span class="line"><span class="keyword">const</span> DiscreteEventContext = <span class="comment">/*         */</span> <span class="number">0b000100</span>;</span><br><span class="line"><span class="keyword">const</span> LegacyUnbatchedContext = <span class="comment">/*       */</span> <span class="number">0b001000</span>;</span><br><span class="line"><span class="keyword">const</span> RenderContext = <span class="comment">/*                */</span> <span class="number">0b010000</span>;</span><br><span class="line"><span class="keyword">const</span> CommitContext = <span class="comment">/*                */</span> <span class="number">0b100000</span>;</span><br></pre></td></tr></table></figure>

<p>unbatchedUpdates 函数设定当前状态,然后运行了 updateContainer 函数, 并且使用了 try finally 函数在执行完成之后还原了原来的状态</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">unbatchedUpdates</span>&lt;<span class="title">A</span>, <span class="title">R</span>&gt;(<span class="params">fn: (a: A) =&gt; R, a: A</span>): <span class="title">R</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> prevExecutionContext = executionContext;</span><br><span class="line">  executionContext &amp;= BatchedContext~;</span><br><span class="line">  executionContext |= LegacyUnbatchedContext;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> fn(a);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    executionContext = prevExecutionContext;</span><br><span class="line">    <span class="keyword">if</span> (executionContext === NoContext) &#123;</span><br><span class="line">      <span class="comment">// Flush the immediate callbacks that were scheduled during this batch</span></span><br><span class="line">      flushSyncCallbackQueue();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="updateContainer"><a href="#updateContainer" class="headerlink" title="updateContainer"></a>updateContainer</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">updateContainer</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  element: ReactNodeList,</span></span></span><br><span class="line"><span class="function"><span class="params">  container: OpaqueRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">  parentComponent: ?React$Component&lt;<span class="built_in">any</span>, <span class="built_in">any</span>&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  callback: ?<span class="built_in">Function</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">ExpirationTime</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> current = container.current; <span class="comment">// get fiber root node</span></span><br><span class="line">  <span class="keyword">const</span> currentTime = requestCurrentTimeForUpdate(); <span class="comment">// 内部进行一些判断, 然后调用msToExpirationTime 返回一个时间戳</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> suspenseConfig = requestCurrentSuspenseConfig();</span><br><span class="line">  <span class="keyword">const</span> expirationTime = computeExpirationForFiber(</span><br><span class="line">    currentTime,</span><br><span class="line">    current,</span><br><span class="line">    suspenseConfig</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> context = getContextForSubtree(parentComponent);</span><br><span class="line">  <span class="keyword">if</span> (container.context === <span class="literal">null</span>) &#123;</span><br><span class="line">    container.context = context;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    container.pendingContext = context;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 省略一些检查代码</span></span><br><span class="line">  <span class="keyword">const</span> update = createUpdate(expirationTime, suspenseConfig);</span><br><span class="line">  <span class="comment">// Caution: React DevTools currently depends on this property</span></span><br><span class="line">  <span class="comment">// being called &quot;element&quot;.</span></span><br><span class="line">  update.payload = &#123; element &#125;;</span><br><span class="line"></span><br><span class="line">  callback = callback === <span class="literal">undefined</span> ? <span class="literal">null</span> : callback;</span><br><span class="line">  <span class="comment">// 省略一下检查代码</span></span><br><span class="line">  enqueueUpdate(current, update); <span class="comment">// 为当前 Fiber 对象构建一个 updateQueue 对象</span></span><br><span class="line">  <span class="comment">// 更新了一些Fiber上的过期时间</span></span><br><span class="line">  <span class="comment">// 然后调用 performSyncWorkOnRoot 同步更新</span></span><br><span class="line">  scheduleUpdateOnFiber(current, expirationTime);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> expirationTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="performSyncWorkOnRoot"><a href="#performSyncWorkOnRoot" class="headerlink" title="performSyncWorkOnRoot"></a>performSyncWorkOnRoot</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// This is the entry point for synchronous tasks that don&#x27;t go</span></span><br><span class="line"><span class="comment">// through Scheduler</span></span><br><span class="line"><span class="comment">// 同步任务切入点</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">performSyncWorkOnRoot</span>(<span class="params">root</span>) </span>&#123;</span><br><span class="line">  invariant(</span><br><span class="line">    (executionContext &amp; (RenderContext | CommitContext)) === NoContext,</span><br><span class="line">    <span class="string">&#x27;Should not already be working.&#x27;</span>,</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  flushPassiveEffects();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> lastExpiredTime = root.lastExpiredTime;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> expirationTime;</span><br><span class="line">  <span class="keyword">if</span> (lastExpiredTime !== NoWork) &#123;</span><br><span class="line">    <span class="comment">// There&#x27;s expired work on this root. Check if we have a partial tree</span></span><br><span class="line">    <span class="comment">// that we can reuse.</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      root === workInProgressRoot &amp;&amp;</span><br><span class="line">      renderExpirationTime &gt;= lastExpiredTime</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="comment">// There&#x27;s a partial tree with equal or greater than priority than the</span></span><br><span class="line">      <span class="comment">// expired level. Finish rendering it before rendering the rest of the</span></span><br><span class="line">      <span class="comment">// expired work.</span></span><br><span class="line">      expirationTime = renderExpirationTime;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Start a fresh tree.</span></span><br><span class="line">      expirationTime = lastExpiredTime;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// There&#x27;s no expired work. This must be a new, synchronous render.</span></span><br><span class="line">    expirationTime = Sync;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> exitStatus = renderRootSync(root, expirationTime);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (root.tag !== LegacyRoot &amp;&amp; exitStatus === RootErrored) &#123;</span><br><span class="line">    <span class="comment">// If something threw an error, try rendering one more time. We&#x27;ll</span></span><br><span class="line">    <span class="comment">// render synchronously to block concurrent data mutations, and we&#x27;ll</span></span><br><span class="line">    <span class="comment">// render at Idle (or lower) so that all pending updates are included.</span></span><br><span class="line">    <span class="comment">// If it still fails after the second attempt, we&#x27;ll give up and commit</span></span><br><span class="line">    <span class="comment">// the resulting tree.</span></span><br><span class="line">    expirationTime = expirationTime &gt; Idle ? Idle : expirationTime;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    exitStatus = renderRootSync(root, expirationTime);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (exitStatus === RootFatalErrored) &#123;</span><br><span class="line">    <span class="keyword">const</span> fatalError = workInProgressRootFatalError;</span><br><span class="line">    prepareFreshStack(root, expirationTime);</span><br><span class="line">    markRootSuspendedAtTime(root, expirationTime);</span><br><span class="line">    ensureRootIsScheduled(root);</span><br><span class="line">    <span class="keyword">throw</span> fatalError;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// We now have a consistent tree. Because this is a sync render, we</span></span><br><span class="line">  <span class="comment">// will commit it even if something suspended.</span></span><br><span class="line">  <span class="keyword">const</span> finishedWork: Fiber = (root.current.alternate: <span class="built_in">any</span>);</span><br><span class="line">  root.finishedWork = finishedWork;</span><br><span class="line">  root.finishedExpirationTime = expirationTime;</span><br><span class="line">  root.nextKnownPendingLevel = getRemainingExpirationTime(finishedWork);</span><br><span class="line">  commitRoot(root);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Before exiting, make sure there&#x27;s a callback scheduled for the next</span></span><br><span class="line">  <span class="comment">// pending level.</span></span><br><span class="line">  ensureRootIsScheduled(root);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="renderRootSync"><a href="#renderRootSync" class="headerlink" title="renderRootSync"></a>renderRootSync</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">renderRootSync</span>(<span class="params">root, expirationTime</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> prevExecutionContext = executionContext;</span><br><span class="line">  executionContext |= RenderContext; <span class="comment">// 调整当前上下文为 renderContext</span></span><br><span class="line">  <span class="keyword">const</span> prevDispatcher = pushDispatcher(root); <span class="comment">// 获得并且给 React 部分赋值 Hooks 钩子</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// If the root or expiration time have changed, throw out the existing stack</span></span><br><span class="line">  <span class="comment">// and prepare a fresh one. Otherwise we&#x27;ll continue where we left off.</span></span><br><span class="line">  <span class="keyword">if</span> (root !== workInProgressRoot || expirationTime !== renderExpirationTime) &#123;</span><br><span class="line">    <span class="comment">// prepareFreshStack 函数会判断 FiberRoot 是否有  alternate 属性 如果没有那么 调用  createWorkInProgress clone</span></span><br><span class="line">    <span class="comment">// root.alternate === workInProgress , workInProgress.alternate === root</span></span><br><span class="line">    prepareFreshStack(root, expirationTime);</span><br><span class="line">    startWorkOnPendingInteractions(root, expirationTime);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> prevInteractions = pushInteractions(root);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      workLoopSync(); <span class="comment">// work work work :)</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (thrownValue) &#123;</span><br><span class="line">      handleError(root, thrownValue);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">while</span> (<span class="literal">true</span>);</span><br><span class="line">  resetContextDependencies();</span><br><span class="line">  <span class="keyword">if</span> (enableSchedulerTracing) &#123;</span><br><span class="line">    popInteractions(((prevInteractions: <span class="built_in">any</span>): <span class="built_in">Set</span>&lt;Interaction&gt;));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  executionContext = prevExecutionContext;</span><br><span class="line">  popDispatcher(prevDispatcher);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (workInProgress !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// This is a sync render, so we should have finished the whole tree.</span></span><br><span class="line">    invariant(</span><br><span class="line">      <span class="literal">false</span>,</span><br><span class="line">      <span class="string">&#x27;Cannot commit an incomplete root. This error is likely caused by a &#x27;</span> +</span><br><span class="line">        <span class="string">&#x27;bug in React. Please file an issue.&#x27;</span>,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    <span class="keyword">if</span> (enableDebugTracing) &#123;</span><br><span class="line">      logRenderStopped();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Set this to null to indicate there&#x27;s no in-progress render.</span></span><br><span class="line">  workInProgressRoot = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> workInProgressRootExitStatus;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="workLoopSync"><a href="#workLoopSync" class="headerlink" title="workLoopSync"></a>workLoopSync</h3><p>workLoopSync 会调用 performUnitOfWork 函数</p>
<h3 id="performUnitOfWork-函数"><a href="#performUnitOfWork-函数" class="headerlink" title="performUnitOfWork 函数"></a>performUnitOfWork 函数</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">performUnitOfWork</span>(<span class="params">unitOfWork: Fiber</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="comment">// The current, flushed, state of this fiber is the alternate. Ideally</span></span><br><span class="line">  <span class="comment">// nothing should rely on this, but relying on it here means that we don&#x27;t</span></span><br><span class="line">  <span class="comment">// need an additional field on the work in progress.</span></span><br><span class="line">  <span class="keyword">const</span> current = unitOfWork.alternate; <span class="comment">// 通过 alternate 取到  FiberRoot对象</span></span><br><span class="line">  setCurrentDebugFiberInDEV(unitOfWork);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> next;</span><br><span class="line">  <span class="keyword">if</span> (enableProfilerTimer &amp;&amp; (unitOfWork.mode &amp; ProfileMode) !== NoMode) &#123;</span><br><span class="line">    startProfilerTimer(unitOfWork);</span><br><span class="line">    next = beginWork(current, unitOfWork, renderExpirationTime);</span><br><span class="line">    stopProfilerTimerIfRunningAndRecordDelta(unitOfWork, <span class="literal">true</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    next = beginWork(current, unitOfWork, renderExpirationTime);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  resetCurrentDebugFiberInDEV();</span><br><span class="line">  unitOfWork.memoizedProps = unitOfWork.pendingProps;</span><br><span class="line">  <span class="keyword">if</span> (next === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// If this doesn&#x27;t spawn new work, complete the current work.</span></span><br><span class="line">    completeUnitOfWork(unitOfWork);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    workInProgress = next;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ReactCurrentOwner.current = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="beginWork"><a href="#beginWork" class="headerlink" title="beginWork"></a>beginWork</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> beginWork;</span><br><span class="line"><span class="keyword">if</span> (__DEV__ &amp;&amp; replayFailedUnitOfWorkWithInvokeGuardedCallback) &#123;</span><br><span class="line">  <span class="keyword">const</span> dummyFiber = <span class="literal">null</span>;</span><br><span class="line">  beginWork = <span class="function">(<span class="params">current, unitOfWork, expirationTime</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// If a component throws an error, we replay it again in a synchronously</span></span><br><span class="line">    <span class="comment">// dispatched event, so that the debugger will treat it as an uncaught</span></span><br><span class="line">    <span class="comment">// error See ReactErrorUtils for more information.</span></span><br><span class="line">    <span class="comment">// 如果以组件抛出一个错误, 我们可以在调度事件中重新进行一次, 浏览器会将其视为错误</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Before entering the begin phase, copy the work-in-progress onto a dummy</span></span><br><span class="line">    <span class="comment">// fiber. If beginWork throws, we&#x27;ll use this to reset the state.</span></span><br><span class="line">    <span class="comment">// 开始之前先将对象复制一下预防出错,出错后可以还原, 开发下行为</span></span><br><span class="line">    <span class="keyword">const</span> originalWorkInProgressCopy = assignFiberPropertiesInDEV(</span><br><span class="line">      dummyFiber,</span><br><span class="line">      unitOfWork,</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> originalBeginWork(current, unitOfWork, expirationTime);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (originalError) &#123;</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        originalError !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">        <span class="keyword">typeof</span> originalError === <span class="string">&#x27;object&#x27;</span> &amp;&amp;</span><br><span class="line">        <span class="keyword">typeof</span> originalError.then === <span class="string">&#x27;function&#x27;</span></span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="comment">// Don&#x27;t replay promises. Treat everything else like an error.</span></span><br><span class="line">        <span class="keyword">throw</span> originalError;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Keep this code in sync with handleError; any changes here must have</span></span><br><span class="line">      <span class="comment">// corresponding changes there.</span></span><br><span class="line">      resetContextDependencies();</span><br><span class="line">      resetHooksAfterThrow();</span><br><span class="line">      <span class="comment">// Don&#x27;t reset current debug fiber, since we&#x27;re about to work on the</span></span><br><span class="line">      <span class="comment">// same fiber again.</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// Unwind the failed stack frame</span></span><br><span class="line">      unwindInterruptedWork(unitOfWork);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Restore the original properties of the fiber.</span></span><br><span class="line">      assignFiberPropertiesInDEV(unitOfWork, originalWorkInProgressCopy);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (enableProfilerTimer &amp;&amp; unitOfWork.mode &amp; ProfileMode) &#123;</span><br><span class="line">        <span class="comment">// Reset the profiler timer.</span></span><br><span class="line">        startProfilerTimer(unitOfWork);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Run beginWork again.</span></span><br><span class="line">      invokeGuardedCallback(</span><br><span class="line">        <span class="literal">null</span>,</span><br><span class="line">        originalBeginWork,</span><br><span class="line">        <span class="literal">null</span>,</span><br><span class="line">        current,</span><br><span class="line">        unitOfWork,</span><br><span class="line">        expirationTime,</span><br><span class="line">      );</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (hasCaughtError()) &#123;</span><br><span class="line">        <span class="keyword">const</span> replayError = clearCaughtError();</span><br><span class="line">        <span class="comment">// `invokeGuardedCallback` sometimes sets an expando `_suppressLogging`.</span></span><br><span class="line">        <span class="comment">// Rethrow this error instead of the original one.</span></span><br><span class="line">        <span class="keyword">throw</span> replayError;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// This branch is reachable if the render phase is impure.</span></span><br><span class="line">        <span class="keyword">throw</span> originalError;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125; <span class="keyword">else</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="originalBeginWork"><a href="#originalBeginWork" class="headerlink" title="originalBeginWork"></a>originalBeginWork</h3><p>这个流程就是将 Fiber 树构建出来, 并且将元素也初始化出来下一步就是直接 commit 到 DOM 了</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">beginWork</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  current: Fiber | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  renderExpirationTime: ExpirationTime,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Fiber</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> updateExpirationTime = workInProgress.expirationTime;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> oldProps = current.memoizedProps;</span><br><span class="line">    <span class="keyword">const</span> newProps = workInProgress.pendingProps;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      oldProps !== newProps ||</span><br><span class="line">      hasLegacyContextChanged() ||</span><br><span class="line">      <span class="comment">// Force a re-render if the implementation changed due to hot reload:</span></span><br><span class="line">      (__DEV__ ? workInProgress.type !== current.type : <span class="literal">false</span>)</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="comment">// If props or context changed, mark the fiber as having performed work.</span></span><br><span class="line">      <span class="comment">// This may be unset if the props are determined to be equal later (memo).</span></span><br><span class="line">      didReceiveUpdate = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (updateExpirationTime &lt; renderExpirationTime) &#123;</span><br><span class="line">      didReceiveUpdate = <span class="literal">false</span>;</span><br><span class="line">      <span class="comment">// This fiber does not have any pending work. Bailout without entering</span></span><br><span class="line">      <span class="comment">// the begin phase. There&#x27;s still some bookkeeping we that needs to be done</span></span><br><span class="line">      <span class="comment">// in this optimized path, mostly pushing stuff onto the stack.</span></span><br><span class="line">      <span class="keyword">switch</span> (workInProgress.tag) &#123;</span><br><span class="line">        <span class="keyword">case</span> HostRoot:</span><br><span class="line">          pushHostRootContext(workInProgress);</span><br><span class="line">          resetHydrationState();</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> HostComponent:</span><br><span class="line">          pushHostContext(workInProgress);</span><br><span class="line">          <span class="keyword">if</span> (</span><br><span class="line">            workInProgress.mode &amp; ConcurrentMode &amp;&amp;</span><br><span class="line">            renderExpirationTime !== Never &amp;&amp;</span><br><span class="line">            shouldDeprioritizeSubtree(workInProgress.type, newProps)</span><br><span class="line">          ) &#123;</span><br><span class="line">            <span class="keyword">if</span> (enableSchedulerTracing) &#123;</span><br><span class="line">              markSpawnedWork(Never);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Schedule this fiber to re-render at offscreen priority. Then bailout.</span></span><br><span class="line">            workInProgress.expirationTime = workInProgress.childExpirationTime = Never;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ClassComponent: &#123;</span><br><span class="line">          <span class="keyword">const</span> Component = workInProgress.type;</span><br><span class="line">          <span class="keyword">if</span> (isLegacyContextProvider(Component)) &#123;</span><br><span class="line">            pushLegacyContextProvider(workInProgress);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> HostPortal:</span><br><span class="line">          pushHostContainer(</span><br><span class="line">            workInProgress,</span><br><span class="line">            workInProgress.stateNode.containerInfo,</span><br><span class="line">          );</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ContextProvider: &#123;</span><br><span class="line">          <span class="keyword">const</span> newValue = workInProgress.memoizedProps.value;</span><br><span class="line">          pushProvider(workInProgress, newValue);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> Profiler:</span><br><span class="line">          <span class="keyword">if</span> (enableProfilerTimer) &#123;</span><br><span class="line">            <span class="comment">// Profiler should only call onRender when one of its descendants actually rendered.</span></span><br><span class="line">            <span class="keyword">const</span> hasChildWork =</span><br><span class="line">              workInProgress.childExpirationTime &gt;= renderExpirationTime;</span><br><span class="line">            <span class="keyword">if</span> (hasChildWork) &#123;</span><br><span class="line">              workInProgress.effectTag |= Update;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Reset effect durations for the next eventual effect phase.</span></span><br><span class="line">            <span class="comment">// These are reset during render to allow the DevTools commit hook a chance to read them,</span></span><br><span class="line">            <span class="keyword">const</span> stateNode = workInProgress.stateNode;</span><br><span class="line">            stateNode.effectDuration = <span class="number">0</span>;</span><br><span class="line">            stateNode.passiveEffectDuration = <span class="number">0</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SuspenseComponent: &#123;</span><br><span class="line">          <span class="keyword">const</span> state: SuspenseState | <span class="literal">null</span> = workInProgress.memoizedState;</span><br><span class="line">          <span class="keyword">if</span> (state !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (enableSuspenseServerRenderer) &#123;</span><br><span class="line">              <span class="keyword">if</span> (state.dehydrated !== <span class="literal">null</span>) &#123;</span><br><span class="line">                pushSuspenseContext(</span><br><span class="line">                  workInProgress,</span><br><span class="line">                  setDefaultShallowSuspenseContext(suspenseStackCursor.current),</span><br><span class="line">                );</span><br><span class="line">                <span class="comment">// We know that this component will suspend again because if it has</span></span><br><span class="line">                <span class="comment">// been unsuspended it has committed as a resolved Suspense component.</span></span><br><span class="line">                <span class="comment">// If it needs to be retried, it should have work scheduled on it.</span></span><br><span class="line">                workInProgress.effectTag |= DidCapture;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If this boundary is currently timed out, we need to decide</span></span><br><span class="line">            <span class="comment">// whether to retry the primary children, or to skip over it and</span></span><br><span class="line">            <span class="comment">// go straight to the fallback. Check the priority of the primary</span></span><br><span class="line">            <span class="comment">// child fragment.</span></span><br><span class="line">            <span class="keyword">const</span> primaryChildFragment: Fiber = (workInProgress.child: <span class="built_in">any</span>);</span><br><span class="line">            <span class="keyword">const</span> primaryChildExpirationTime =</span><br><span class="line">              primaryChildFragment.childExpirationTime;</span><br><span class="line">            <span class="keyword">if</span> (primaryChildExpirationTime &gt;= renderExpirationTime) &#123;</span><br><span class="line">              <span class="comment">// The primary children have pending work. Use the normal path</span></span><br><span class="line">              <span class="comment">// to attempt to render the primary children again.</span></span><br><span class="line">              <span class="keyword">return</span> updateSuspenseComponent(</span><br><span class="line">                current,</span><br><span class="line">                workInProgress,</span><br><span class="line">                renderExpirationTime,</span><br><span class="line">              );</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="comment">// The primary child fragment does not have pending work marked</span></span><br><span class="line">              <span class="comment">// on it...</span></span><br><span class="line"></span><br><span class="line">              <span class="comment">// ...usually. There&#x27;s an unfortunate edge case where the fragment</span></span><br><span class="line">              <span class="comment">// fiber is not part of the return path of the children, so when</span></span><br><span class="line">              <span class="comment">// an update happens, the fragment doesn&#x27;t get marked during</span></span><br><span class="line">              <span class="comment">// setState. This is something we should consider addressing when</span></span><br><span class="line">              <span class="comment">// we refactor the Fiber data structure. (There&#x27;s a test with more</span></span><br><span class="line">              <span class="comment">// details; to find it, comment out the following block and see</span></span><br><span class="line">              <span class="comment">// which one fails.)</span></span><br><span class="line">              <span class="comment">//</span></span><br><span class="line">              <span class="comment">// As a workaround, we need to recompute the `childExpirationTime`</span></span><br><span class="line">              <span class="comment">// by bubbling it up from the next level of children. This is</span></span><br><span class="line">              <span class="comment">// based on similar logic in `resetChildExpirationTime`.</span></span><br><span class="line">              <span class="keyword">let</span> primaryChild = primaryChildFragment.child;</span><br><span class="line">              <span class="keyword">while</span> (primaryChild !== <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">const</span> childUpdateExpirationTime = primaryChild.expirationTime;</span><br><span class="line">                <span class="keyword">const</span> childChildExpirationTime =</span><br><span class="line">                  primaryChild.childExpirationTime;</span><br><span class="line">                <span class="keyword">if</span> (</span><br><span class="line">                  childUpdateExpirationTime &gt;= renderExpirationTime ||</span><br><span class="line">                  childChildExpirationTime &gt;= renderExpirationTime</span><br><span class="line">                ) &#123;</span><br><span class="line">                  <span class="comment">// Found a child with an update with sufficient priority.</span></span><br><span class="line">                  <span class="comment">// Use the normal path to render the primary children again.</span></span><br><span class="line">                  <span class="keyword">return</span> updateSuspenseComponent(</span><br><span class="line">                    current,</span><br><span class="line">                    workInProgress,</span><br><span class="line">                    renderExpirationTime,</span><br><span class="line">                  );</span><br><span class="line">                &#125;</span><br><span class="line">                primaryChild = primaryChild.sibling;</span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">              pushSuspenseContext(</span><br><span class="line">                workInProgress,</span><br><span class="line">                setDefaultShallowSuspenseContext(suspenseStackCursor.current),</span><br><span class="line">              );</span><br><span class="line">              <span class="comment">// The primary children do not have pending work with sufficient</span></span><br><span class="line">              <span class="comment">// priority. Bailout.</span></span><br><span class="line">              <span class="keyword">const</span> child = bailoutOnAlreadyFinishedWork(</span><br><span class="line">                current,</span><br><span class="line">                workInProgress,</span><br><span class="line">                renderExpirationTime,</span><br><span class="line">              );</span><br><span class="line">              <span class="keyword">if</span> (child !== <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// The fallback children have pending work. Skip over the</span></span><br><span class="line">                <span class="comment">// primary children and work on the fallback.</span></span><br><span class="line">                <span class="keyword">return</span> child.sibling;</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            pushSuspenseContext(</span><br><span class="line">              workInProgress,</span><br><span class="line">              setDefaultShallowSuspenseContext(suspenseStackCursor.current),</span><br><span class="line">            );</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> SuspenseListComponent: &#123;</span><br><span class="line">          <span class="keyword">const</span> didSuspendBefore =</span><br><span class="line">            (current.effectTag &amp; DidCapture) !== NoEffect;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">const</span> hasChildWork =</span><br><span class="line">            workInProgress.childExpirationTime &gt;= renderExpirationTime;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (didSuspendBefore) &#123;</span><br><span class="line">            <span class="keyword">if</span> (hasChildWork) &#123;</span><br><span class="line">              <span class="comment">// If something was in fallback state last time, and we have all the</span></span><br><span class="line">              <span class="comment">// same children then we&#x27;re still in progressive loading state.</span></span><br><span class="line">              <span class="comment">// Something might get unblocked by state updates or retries in the</span></span><br><span class="line">              <span class="comment">// tree which will affect the tail. So we need to use the normal</span></span><br><span class="line">              <span class="comment">// path to compute the correct tail.</span></span><br><span class="line">              <span class="keyword">return</span> updateSuspenseListComponent(</span><br><span class="line">                current,</span><br><span class="line">                workInProgress,</span><br><span class="line">                renderExpirationTime,</span><br><span class="line">              );</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// If none of the children had any work, that means that none of</span></span><br><span class="line">            <span class="comment">// them got retried so they&#x27;ll still be blocked in the same way</span></span><br><span class="line">            <span class="comment">// as before. We can fast bail out.</span></span><br><span class="line">            workInProgress.effectTag |= DidCapture;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// If nothing suspended before and we&#x27;re rendering the same children,</span></span><br><span class="line">          <span class="comment">// then the tail doesn&#x27;t matter. Anything new that suspends will work</span></span><br><span class="line">          <span class="comment">// in the &quot;together&quot; mode, so we can continue from the state we had.</span></span><br><span class="line">          <span class="keyword">const</span> renderState = workInProgress.memoizedState;</span><br><span class="line">          <span class="keyword">if</span> (renderState !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Reset to the &quot;together&quot; mode in case we&#x27;ve started a different</span></span><br><span class="line">            <span class="comment">// update in the past but didn&#x27;t complete it.</span></span><br><span class="line">            renderState.rendering = <span class="literal">null</span>;</span><br><span class="line">            renderState.tail = <span class="literal">null</span>;</span><br><span class="line">            renderState.lastEffect = <span class="literal">null</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          pushSuspenseContext(workInProgress, suspenseStackCursor.current);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (hasChildWork) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// If none of the children had any work, that means that none of</span></span><br><span class="line">            <span class="comment">// them got retried so they&#x27;ll still be blocked in the same way</span></span><br><span class="line">            <span class="comment">// as before. We can fast bail out.</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> bailoutOnAlreadyFinishedWork(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        renderExpirationTime,</span><br><span class="line">      );</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// An update was scheduled on this fiber, but there are no new props</span></span><br><span class="line">      <span class="comment">// nor legacy context. Set this to false. If an update queue or context</span></span><br><span class="line">      <span class="comment">// consumer produces a changed value, it will set this to true. Otherwise,</span></span><br><span class="line">      <span class="comment">// the component will assume the children have not changed and bail out.</span></span><br><span class="line">      didReceiveUpdate = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    didReceiveUpdate = <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Before entering the begin phase, clear pending update priority.</span></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> This assumes that we&#x27;re about to evaluate the component and process</span></span><br><span class="line">  <span class="comment">// the update queue. However, there&#x27;s an exception: SimpleMemoComponent</span></span><br><span class="line">  <span class="comment">// sometimes bails out later in the begin phase. This indicates that we should</span></span><br><span class="line">  <span class="comment">// move this assignment out of the common path and into each branch.</span></span><br><span class="line"></span><br><span class="line">  workInProgress.expirationTime = NoWork;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 匹配当前Fiber对象的 tag 关于 Fiber tag 的具体值 上文有</span></span><br><span class="line">  <span class="comment">// 这里的每个 tag 匹配一个函数 分别处理不同的对象</span></span><br><span class="line">  <span class="keyword">switch</span> (workInProgress.tag) &#123;</span><br><span class="line">    <span class="keyword">case</span> IndeterminateComponent: &#123;</span><br><span class="line">      <span class="keyword">return</span> mountIndeterminateComponent(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        workInProgress.type,</span><br><span class="line">        renderExpirationTime,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> LazyComponent: &#123;</span><br><span class="line">      <span class="keyword">const</span> elementType = workInProgress.elementType;</span><br><span class="line">      <span class="keyword">return</span> mountLazyComponent(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        elementType,</span><br><span class="line">        updateExpirationTime,</span><br><span class="line">        renderExpirationTime,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> FunctionComponent: &#123;</span><br><span class="line">      <span class="keyword">const</span> Component = workInProgress.type;</span><br><span class="line">      <span class="keyword">const</span> unresolvedProps = workInProgress.pendingProps;</span><br><span class="line">      <span class="keyword">const</span> resolvedProps =</span><br><span class="line">        workInProgress.elementType === Component</span><br><span class="line">          ? unresolvedProps</span><br><span class="line">          : resolveDefaultProps(Component, unresolvedProps);</span><br><span class="line">      <span class="keyword">return</span> updateFunctionComponent(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        Component,</span><br><span class="line">        resolvedProps,</span><br><span class="line">        renderExpirationTime,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> ClassComponent: &#123;</span><br><span class="line">      <span class="keyword">const</span> Component = workInProgress.type;</span><br><span class="line">      <span class="keyword">const</span> unresolvedProps = workInProgress.pendingProps;</span><br><span class="line">      <span class="keyword">const</span> resolvedProps =</span><br><span class="line">        workInProgress.elementType === Component</span><br><span class="line">          ? unresolvedProps</span><br><span class="line">          : resolveDefaultProps(Component, unresolvedProps);</span><br><span class="line">      <span class="keyword">return</span> updateClassComponent(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        Component,</span><br><span class="line">        resolvedProps,</span><br><span class="line">        renderExpirationTime,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> HostRoot:</span><br><span class="line">      <span class="keyword">return</span> updateHostRoot(current, workInProgress, renderExpirationTime);</span><br><span class="line">    <span class="keyword">case</span> HostComponent:</span><br><span class="line">      <span class="keyword">return</span> updateHostComponent(current, workInProgress, renderExpirationTime);</span><br><span class="line">    <span class="keyword">case</span> HostText:</span><br><span class="line">      <span class="keyword">return</span> updateHostText(current, workInProgress);</span><br><span class="line">    <span class="keyword">case</span> SuspenseComponent:</span><br><span class="line">      <span class="keyword">return</span> updateSuspenseComponent(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        renderExpirationTime,</span><br><span class="line">      );</span><br><span class="line">    <span class="keyword">case</span> HostPortal:</span><br><span class="line">      <span class="keyword">return</span> updatePortalComponent(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        renderExpirationTime,</span><br><span class="line">      );</span><br><span class="line">    <span class="keyword">case</span> ForwardRef: &#123;</span><br><span class="line">      <span class="keyword">const</span> <span class="keyword">type</span> = workInProgress.type;</span><br><span class="line">      <span class="keyword">const</span> unresolvedProps = workInProgress.pendingProps;</span><br><span class="line">      <span class="keyword">const</span> resolvedProps =</span><br><span class="line">        workInProgress.elementType === <span class="keyword">type</span></span><br><span class="line">          ? unresolvedProps</span><br><span class="line">          : resolveDefaultProps(<span class="keyword">type</span>, unresolvedProps);</span><br><span class="line">      <span class="keyword">return</span> updateForwardRef(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        <span class="keyword">type</span>,</span><br><span class="line">        resolvedProps,</span><br><span class="line">        renderExpirationTime,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> Fragment:</span><br><span class="line">      <span class="keyword">return</span> updateFragment(current, workInProgress, renderExpirationTime);</span><br><span class="line">    <span class="keyword">case</span> Mode:</span><br><span class="line">      <span class="keyword">return</span> updateMode(current, workInProgress, renderExpirationTime);</span><br><span class="line">    <span class="keyword">case</span> Profiler:</span><br><span class="line">      <span class="keyword">return</span> updateProfiler(current, workInProgress, renderExpirationTime);</span><br><span class="line">    <span class="keyword">case</span> ContextProvider:</span><br><span class="line">      <span class="keyword">return</span> updateContextProvider(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        renderExpirationTime,</span><br><span class="line">      );</span><br><span class="line">    <span class="keyword">case</span> ContextConsumer:</span><br><span class="line">      <span class="keyword">return</span> updateContextConsumer(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        renderExpirationTime,</span><br><span class="line">      );</span><br><span class="line">    <span class="keyword">case</span> MemoComponent: &#123;</span><br><span class="line">      <span class="keyword">const</span> <span class="keyword">type</span> = workInProgress.type;</span><br><span class="line">      <span class="keyword">const</span> unresolvedProps = workInProgress.pendingProps;</span><br><span class="line">      <span class="comment">// Resolve outer props first, then resolve inner props.</span></span><br><span class="line">      <span class="keyword">let</span> resolvedProps = resolveDefaultProps(<span class="keyword">type</span>, unresolvedProps);</span><br><span class="line">      <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">        <span class="keyword">if</span> (workInProgress.type !== workInProgress.elementType) &#123;</span><br><span class="line">          <span class="keyword">const</span> outerPropTypes = <span class="keyword">type</span>.propTypes;</span><br><span class="line">          <span class="keyword">if</span> (outerPropTypes) &#123;</span><br><span class="line">            checkPropTypes(</span><br><span class="line">              outerPropTypes,</span><br><span class="line">              resolvedProps, <span class="comment">// Resolved for outer only</span></span><br><span class="line">              <span class="string">&#x27;prop&#x27;</span>,</span><br><span class="line">              getComponentName(<span class="keyword">type</span>),</span><br><span class="line">            );</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      resolvedProps = resolveDefaultProps(<span class="keyword">type</span>.type, resolvedProps);</span><br><span class="line">      <span class="keyword">return</span> updateMemoComponent(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        <span class="keyword">type</span>,</span><br><span class="line">        resolvedProps,</span><br><span class="line">        updateExpirationTime,</span><br><span class="line">        renderExpirationTime,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> SimpleMemoComponent: &#123;</span><br><span class="line">      <span class="keyword">return</span> updateSimpleMemoComponent(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        workInProgress.type,</span><br><span class="line">        workInProgress.pendingProps,</span><br><span class="line">        updateExpirationTime,</span><br><span class="line">        renderExpirationTime,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> IncompleteClassComponent: &#123;</span><br><span class="line">      <span class="keyword">const</span> Component = workInProgress.type;</span><br><span class="line">      <span class="keyword">const</span> unresolvedProps = workInProgress.pendingProps;</span><br><span class="line">      <span class="keyword">const</span> resolvedProps =</span><br><span class="line">        workInProgress.elementType === Component</span><br><span class="line">          ? unresolvedProps</span><br><span class="line">          : resolveDefaultProps(Component, unresolvedProps);</span><br><span class="line">      <span class="keyword">return</span> mountIncompleteClassComponent(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        Component,</span><br><span class="line">        resolvedProps,</span><br><span class="line">        renderExpirationTime,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> SuspenseListComponent: &#123;</span><br><span class="line">      <span class="keyword">return</span> updateSuspenseListComponent(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        renderExpirationTime,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> FundamentalComponent: &#123;</span><br><span class="line">      <span class="keyword">if</span> (enableFundamentalAPI) &#123;</span><br><span class="line">        <span class="keyword">return</span> updateFundamentalComponent(</span><br><span class="line">          current,</span><br><span class="line">          workInProgress,</span><br><span class="line">          renderExpirationTime,</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> ScopeComponent: &#123;</span><br><span class="line">      <span class="keyword">if</span> (enableScopeAPI) &#123;</span><br><span class="line">        <span class="keyword">return</span> updateScopeComponent(</span><br><span class="line">          current,</span><br><span class="line">          workInProgress,</span><br><span class="line">          renderExpirationTime,</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> Block: &#123;</span><br><span class="line">      <span class="keyword">if</span> (enableBlocksAPI) &#123;</span><br><span class="line">        <span class="keyword">const</span> block = workInProgress.type;</span><br><span class="line">        <span class="keyword">const</span> props = workInProgress.pendingProps;</span><br><span class="line">        <span class="keyword">return</span> updateBlock(</span><br><span class="line">          current,</span><br><span class="line">          workInProgress,</span><br><span class="line">          block,</span><br><span class="line">          props,</span><br><span class="line">          renderExpirationTime,</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  invariant(</span><br><span class="line">    <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&#x27;Unknown unit of work tag (%s). This error is likely caused by a bug in &#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;React. Please file an issue.&#x27;</span>,</span><br><span class="line">    workInProgress.tag,</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="commit"><a href="#commit" class="headerlink" title="commit"></a>commit</h2><h3 id="finishSyncRender"><a href="#finishSyncRender" class="headerlink" title="finishSyncRender"></a>finishSyncRender</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">finishSyncRender</span>(<span class="params">root</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Set this to null to indicate there&#x27;s no in-progress render.</span></span><br><span class="line">  <span class="comment">// 将此值设置为 null 表示当前没有处于 render 中</span></span><br><span class="line">  workInProgressRoot = <span class="literal">null</span>;</span><br><span class="line">  commitRoot(root);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="commitRootImpl"><a href="#commitRootImpl" class="headerlink" title="commitRootImpl"></a>commitRootImpl</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitRootImpl</span>(<span class="params">root, renderPriorityLevel</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="comment">// `flushPassiveEffects` will call `flushSyncUpdateQueue` at the end, which</span></span><br><span class="line">    <span class="comment">// means `flushPassiveEffects` will sometimes result in additional</span></span><br><span class="line">    <span class="comment">// passive effects. So we need to keep flushing in a loop until there are</span></span><br><span class="line">    <span class="comment">// no more pending effects.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Might be better if `flushPassiveEffects` did not automatically</span></span><br><span class="line">    <span class="comment">// flush synchronous work at the end, to avoid factoring hazards like this.</span></span><br><span class="line">    <span class="comment">// `flushPassiveEffects` 在它结束的时候调用 `flushSyncUpdateQueue` 所以  `flushPassiveEffects` 方法</span></span><br><span class="line">    <span class="comment">// 有时会添加额外的 effect, 所以我们需要保持 flushing 在整个循环内没有 等待处理的 effects</span></span><br><span class="line"></span><br><span class="line">    flushPassiveEffects();</span><br><span class="line">  &#125; <span class="keyword">while</span> (rootWithPendingPassiveEffects !== <span class="literal">null</span>);</span><br><span class="line">  flushRenderPhaseStrictModeWarningsInDEV(); <span class="comment">// 在开发中警告即将被弃用或者改名的生命周期.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  invariant(</span><br><span class="line">    <span class="comment">// react 使用二进制值来确定当前处于什么环境中(处于任务的那个阶段)</span></span><br><span class="line">    (executionContext &amp; (RenderContext | CommitContext)) === NoContext,</span><br><span class="line">    <span class="string">&#x27;Should not already be working.&#x27;</span>,</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 得到处理完成的 fiber 对象</span></span><br><span class="line">  <span class="keyword">const</span> finishedWork = root.finishedWork;</span><br><span class="line">  <span class="keyword">const</span> expirationTime = root.finishedExpirationTime;</span><br><span class="line"></span><br><span class="line">  root.finishedWork = <span class="literal">null</span>;</span><br><span class="line">  root.finishedExpirationTime = NoWork;</span><br><span class="line"></span><br><span class="line">  invariant(</span><br><span class="line">    finishedWork !== root.current,</span><br><span class="line">    <span class="string">&#x27;Cannot commit the same tree as before. This error is likely caused by &#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;a bug in React. Please file an issue.&#x27;</span>,</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="comment">// commitRoot never returns a continuation; it always finishes synchronously.</span></span><br><span class="line">  <span class="comment">// commitRoot 永远是同步进行的不会中断并继续</span></span><br><span class="line">  <span class="comment">// So we can clear these now to allow a new callback to be scheduled.</span></span><br><span class="line">  <span class="comment">// 所以我们清除这些并允许新的 scheduled 新的 callback</span></span><br><span class="line">  root.callbackNode = <span class="literal">null</span>;</span><br><span class="line">  root.callbackExpirationTime = NoWork;</span><br><span class="line">  root.callbackPriority_old = NoPriority;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Update the first and last pending times on this root. The new first</span></span><br><span class="line">  <span class="comment">// pending time is whatever is left on the root fiber.</span></span><br><span class="line">  <span class="comment">// 更新这棵树上 最新和最后等待时间, 新的等待时间就是这棵树上最后剩余的时间</span></span><br><span class="line">  <span class="keyword">const</span> remainingExpirationTimeBeforeCommit = getRemainingExpirationTime(</span><br><span class="line">    finishedWork,</span><br><span class="line">  );</span><br><span class="line">  markRootFinishedAtTime(</span><br><span class="line">    root,</span><br><span class="line">    expirationTime,</span><br><span class="line">    remainingExpirationTimeBeforeCommit,</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (root === workInProgressRoot) &#123;</span><br><span class="line">    <span class="comment">// We can reset these now that they are finished.</span></span><br><span class="line">    workInProgressRoot = <span class="literal">null</span>;</span><br><span class="line">    workInProgress = <span class="literal">null</span>;</span><br><span class="line">    renderExpirationTime = NoWork;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// This indicates that the last root we worked on is not the same one that</span></span><br><span class="line">    <span class="comment">// we&#x27;re committing now. This most commonly happens when a suspended root</span></span><br><span class="line">    <span class="comment">// times out.</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Get the list of effects. 获得 effects list</span></span><br><span class="line">  <span class="keyword">let</span> firstEffect;</span><br><span class="line">  <span class="keyword">if</span> (finishedWork.effectTag &gt; PerformedWork) &#123;</span><br><span class="line">    <span class="comment">// A fiber&#x27;s effect list consists only of its children, not itself. So if</span></span><br><span class="line">    <span class="comment">// the root has an effect, we need to add it to the end of the list. The</span></span><br><span class="line">    <span class="comment">// resulting list is the set that would belong to the root&#x27;s parent, if it</span></span><br><span class="line">    <span class="comment">// had one; that is, all the effects in the tree including the root.</span></span><br><span class="line">    <span class="keyword">if</span> (finishedWork.lastEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">      finishedWork.lastEffect.nextEffect = finishedWork;</span><br><span class="line">      firstEffect = finishedWork.firstEffect;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      firstEffect = finishedWork;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// There is no effect on the root.</span></span><br><span class="line">    firstEffect = finishedWork.firstEffect;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (firstEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> prevExecutionContext = executionContext;</span><br><span class="line">    executionContext |= CommitContext;</span><br><span class="line">    <span class="keyword">const</span> prevInteractions = pushInteractions(root);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Reset this to null before calling lifecycles</span></span><br><span class="line">    <span class="comment">// 在调用生命周期之前将此重置为空</span></span><br><span class="line">    <span class="comment">// 这个属性是个全局对象,current 表明了当前那个组件构造中</span></span><br><span class="line">    ReactCurrentOwner.current = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The commit phase is broken into several sub-phases. We do a separate pass</span></span><br><span class="line">    <span class="comment">// of the effect list for each phase: all mutation effects come before all</span></span><br><span class="line">    <span class="comment">// layout effects, and so on.</span></span><br><span class="line">    <span class="comment">// commit 阶段又分为几个子阶段, 单独为每个阶段做一个独立的 effect list 所有的 可变 effect 都在</span></span><br><span class="line">    <span class="comment">// layout efffect 之前</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// The first phase a &quot;before mutation&quot; phase. We use this phase to read the</span></span><br><span class="line">    <span class="comment">// state of the host tree right before we mutate it. This is where</span></span><br><span class="line">    <span class="comment">// getSnapshotBeforeUpdate is called.</span></span><br><span class="line">    <span class="comment">/// 第一个阶段 &quot;before mutation&quot; 阶段, 我们在这个阶段修改 host tree 之前读取他的状态</span></span><br><span class="line">    <span class="comment">// 并且在此处调用 getSnapshotBeforUpdate</span></span><br><span class="line">    focusedInstanceHandle = prepareForCommit(root.containerInfo);</span><br><span class="line">    shouldFireAfterActiveInstanceBlur = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    nextEffect = firstEffect;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          commitBeforeMutationEffects();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">          invariant(nextEffect !== <span class="literal">null</span>, <span class="string">&#x27;Should be working on an effect.&#x27;</span>);</span><br><span class="line">          captureCommitPhaseError(nextEffect, error);</span><br><span class="line">          nextEffect = nextEffect.nextEffect;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We no longer need to track the active instance fiber</span></span><br><span class="line">    focusedInstanceHandle = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (enableProfilerTimer) &#123;</span><br><span class="line">      <span class="comment">// Mark the current commit time to be shared by all Profilers in this</span></span><br><span class="line">      <span class="comment">// batch. This enables them to be grouped later.</span></span><br><span class="line">      recordCommitTime();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The next phase is the mutation phase, where we mutate the host tree.</span></span><br><span class="line">    <span class="comment">// 下一个阶段是进行变化的阶段,我们对 host tree 进行改变</span></span><br><span class="line">    nextEffect = firstEffect;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">// 这里会向Container 插入实际的DOM</span></span><br><span class="line">          commitMutationEffects(root, renderPriorityLevel);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">          invariant(nextEffect !== <span class="literal">null</span>, <span class="string">&#x27;Should be working on an effect.&#x27;</span>);</span><br><span class="line">          captureCommitPhaseError(nextEffect, error);</span><br><span class="line">          nextEffect = nextEffect.nextEffect;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (shouldFireAfterActiveInstanceBlur) &#123;</span><br><span class="line">      afterActiveInstanceBlur();</span><br><span class="line">    &#125;</span><br><span class="line">    resetAfterCommit(root.containerInfo);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The work-in-progress tree is now the current tree. This must come after</span></span><br><span class="line">    <span class="comment">// the mutation phase, so that the previous tree is still current during</span></span><br><span class="line">    <span class="comment">// componentWillUnmount, but before the layout phase, so that the finished</span></span><br><span class="line">    <span class="comment">// work is current during componentDidMount/Update.</span></span><br><span class="line">    <span class="comment">// 这里正在处理的树现在是 current , 者必须是在 mutation 阶段之后, 所以所以</span></span><br><span class="line">    <span class="comment">// 以前的树在在 componentWillUnmount 阶段仍然是 current 的, 在 layout 戒烟之前,</span></span><br><span class="line">    <span class="comment">// 所以所以 finiished work 在compoentDidMount/Update之前仍然是 current 的</span></span><br><span class="line">    root.current = finishedWork;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The next phase is the layout phase, where we call effects that read</span></span><br><span class="line">    <span class="comment">// the host tree after it&#x27;s been mutated. The idiomatic use case for this is</span></span><br><span class="line">    <span class="comment">// layout, but class component lifecycles also fire here for legacy reasons.</span></span><br><span class="line">    <span class="comment">// 下一个阶段是 layout , 在 host tree 改变之后读取 effects, 惯用是 layout ,但是 class component 声明周期</span></span><br><span class="line">    <span class="comment">// 也会因为遗留问题触发</span></span><br><span class="line">    nextEffect = firstEffect;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">// 这里会对 ref 进行赋值</span></span><br><span class="line">          commitLayoutEffects(root, expirationTime);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">          invariant(nextEffect !== <span class="literal">null</span>, <span class="string">&#x27;Should be working on an effect.&#x27;</span>);</span><br><span class="line">          captureCommitPhaseError(nextEffect, error);</span><br><span class="line">          nextEffect = nextEffect.nextEffect;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">    nextEffect = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Tell Scheduler to yield at the end of the frame, so the browser has an</span></span><br><span class="line">    <span class="comment">// opportunity to paint.</span></span><br><span class="line">    requestPaint();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (enableSchedulerTracing) &#123;</span><br><span class="line">      popInteractions(((prevInteractions: <span class="built_in">any</span>): <span class="built_in">Set</span>&lt;Interaction&gt;));</span><br><span class="line">    &#125;</span><br><span class="line">    executionContext = prevExecutionContext;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// No effects.</span></span><br><span class="line">    root.current = finishedWork;</span><br><span class="line">    <span class="comment">// Measure these anyway so the flamegraph explicitly shows that there were</span></span><br><span class="line">    <span class="comment">// no effects.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Maybe there&#x27;s a better way to report this.</span></span><br><span class="line">    <span class="keyword">if</span> (enableProfilerTimer) &#123;</span><br><span class="line">      recordCommitTime();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> rootDidHavePassiveEffects = rootDoesHavePassiveEffects;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (rootDoesHavePassiveEffects) &#123;</span><br><span class="line">    <span class="comment">// This commit has passive effects. Stash a reference to them. But don&#x27;t</span></span><br><span class="line">    <span class="comment">// schedule a callback until after flushing layout work.</span></span><br><span class="line">    rootDoesHavePassiveEffects = <span class="literal">false</span>;</span><br><span class="line">    rootWithPendingPassiveEffects = root;</span><br><span class="line">    pendingPassiveEffectsExpirationTime = expirationTime;</span><br><span class="line">    pendingPassiveEffectsRenderPriority = renderPriorityLevel;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// We are done with the effect chain at this point so let&#x27;s clear the</span></span><br><span class="line">    <span class="comment">// nextEffect pointers to assist with GC. If we have passive effects, we&#x27;ll</span></span><br><span class="line">    <span class="comment">// clear this in flushPassiveEffects.</span></span><br><span class="line">    <span class="comment">//  我们完成了完成了 effect 链, 现在清理 nextEffect 引用来使 CG 可以清理其中内存</span></span><br><span class="line">    nextEffect = firstEffect;</span><br><span class="line">    <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> nextNextEffect = nextEffect.nextEffect;</span><br><span class="line">      nextEffect.nextEffect = <span class="literal">null</span>;</span><br><span class="line">      nextEffect = nextNextEffect;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check if there&#x27;s remaining work on this root</span></span><br><span class="line">  <span class="comment">// 检查root 上是否还有其他工作</span></span><br><span class="line">  <span class="keyword">const</span> remainingExpirationTime = root.firstPendingTime;</span><br><span class="line">  <span class="keyword">if</span> (remainingExpirationTime !== NoWork) &#123;</span><br><span class="line">    <span class="keyword">if</span> (enableSchedulerTracing) &#123;</span><br><span class="line">      <span class="keyword">if</span> (spawnedWorkDuringRender !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> expirationTimes = spawnedWorkDuringRender;</span><br><span class="line">        spawnedWorkDuringRender = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; expirationTimes.length; i++) &#123;</span><br><span class="line">          scheduleInteractions(</span><br><span class="line">            root,</span><br><span class="line">            expirationTimes[i],</span><br><span class="line">            root.memoizedInteractions,</span><br><span class="line">          );</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      schedulePendingInteractions(root, remainingExpirationTime);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// If there&#x27;s no remaining work, we can clear the set of already failed</span></span><br><span class="line">    <span class="comment">// error boundaries.</span></span><br><span class="line">    legacyErrorBoundariesThatAlreadyFailed = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enableSchedulerTracing) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!rootDidHavePassiveEffects) &#123;</span><br><span class="line">      <span class="comment">// If there are no passive effects, then we can complete the pending interactions.</span></span><br><span class="line">      <span class="comment">// Otherwise, we&#x27;ll wait until after the passive effects are flushed.</span></span><br><span class="line">      <span class="comment">// Wait to do this until after remaining work has been scheduled,</span></span><br><span class="line">      <span class="comment">// so that we don&#x27;t prematurely signal complete for interactions when there&#x27;s e.g. hidden work.</span></span><br><span class="line">      finishPendingInteractions(root, expirationTime);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (remainingExpirationTime === Sync) &#123;</span><br><span class="line">    <span class="comment">// Count the number of times the root synchronously re-renders without</span></span><br><span class="line">    <span class="comment">// finishing. If there are too many, it indicates an infinite update loop.</span></span><br><span class="line">    <span class="keyword">if</span> (root === rootWithNestedUpdates) &#123;</span><br><span class="line">      nestedUpdateCount++;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      nestedUpdateCount = <span class="number">0</span>;</span><br><span class="line">      rootWithNestedUpdates = root;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    nestedUpdateCount = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  onCommitRootDevTools(finishedWork.stateNode, expirationTime);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Always call this before exiting `commitRoot`, to ensure that any</span></span><br><span class="line">  <span class="comment">// additional work on this root is scheduled.</span></span><br><span class="line">  ensureRootIsScheduled(root);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (hasUncaughtError) &#123;</span><br><span class="line">    hasUncaughtError = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">const</span> error = firstUncaughtError;</span><br><span class="line">    firstUncaughtError = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">throw</span> error;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((executionContext &amp; LegacyUnbatchedContext) !== NoContext) &#123;</span><br><span class="line">    <span class="comment">// This is a legacy edge case. We just committed the initial mount of</span></span><br><span class="line">    <span class="comment">// a ReactDOM.render-ed root inside of batchedUpdates. The commit fired</span></span><br><span class="line">    <span class="comment">// synchronously, but layout updates should be deferred until the end</span></span><br><span class="line">    <span class="comment">// of the batch.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If layout work was scheduled, flush it now.</span></span><br><span class="line">  flushSyncCallbackQueue();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    <span class="keyword">if</span> (enableDebugTracing) &#123;</span><br><span class="line">      logCommitStopped();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/React/" rel="tag"># React</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2020/03/23/React/" rel="prev" title="React">
                  <i class="fa fa-chevron-left"></i> React
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2020/05/16/React%20Update/" rel="next" title="React Update">
                  React Update <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>







<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">H</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
